name: Python Runtime Diagnostics

on:
  workflow_dispatch:
  push:
    branches: [ "debug-python-env" ]

permissions:
  contents: read

jobs:
  proof:
    name: "Python ${{ matrix.python-version }} on ${{ matrix.arch }}"
    runs-on: ${{ matrix.runner }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            runner: ubuntu-latest
            python-setup: actions
            python-version: "3.11"

          - arch: ppc64le
            runner: ubuntu-24.04-ppc64le
            python-setup: ibm
            python-version: "3.11"

    steps:

    # ------------------------------------------------------------
    # BASELINE RUNNER ENV (FIRST STEP â€” BEFORE ANY MUTATION)
    # ------------------------------------------------------------
    - name: Baseline runner environment
      shell: bash
      run: |
        set -eux

        echo "===== ALL ENV VARS (SORTED) ====="
        env | sort

        echo "===== RUNNER VARS ====="
        env | grep -E '^RUNNER_' | sort || true

        echo "===== GITHUB VARS ====="
        env | grep -E '^GITHUB_' | sort || true

        echo "===== TOOLCACHE VARS ====="
        echo "RUNNER_TOOL_CACHE=$RUNNER_TOOL_CACHE"
        echo "AGENT_TOOLSDIRECTORY=${AGENT_TOOLSDIRECTORY:-<unset>}"

        echo "===== PATH (LINE BY LINE) ====="
        echo "$PATH" | tr ':' '\n'

        echo "===== FILESYSTEM LOCATIONS ====="
        echo "HOME=$HOME"
        echo "PWD=$PWD"
        ls -ld "$RUNNER_TOOL_CACHE" || true

    # ------------------------------------------------------------
    # Checkout
    # ------------------------------------------------------------
    - uses: actions/checkout@v4

    # ------------------------------------------------------------
    # Runner context
    # ------------------------------------------------------------
    - name: Runner context
      run: |
        set -eux
        cat /etc/os-release || true
        uname -a
        lscpu || true
        uname -m
        arch
        dpkg --print-architecture || true

    # ------------------------------------------------------------
    # Setup Python
    # ------------------------------------------------------------
    - name: Setup Python (actions)
      if: matrix.python-setup == 'actions'
      id: setup
      uses: actions/setup-python@v6
      with:
        python-version: ${{ matrix.python-version }}

    - name: Setup Python (IBM)
      if: matrix.python-setup == 'ibm'
      id: setup
      uses: IBM/setup-python-pz@v6
      with:
        python-version: ${{ matrix.python-version }}
        architecture: ppc64le

    # ------------------------------------------------------------
    # Action outputs
    # ------------------------------------------------------------
    - name: Action outputs
      run: |
        echo "python-path: ${{ steps.setup.outputs.python-path }}"
        echo "python-version: ${{ steps.setup.outputs.python-version }}"

    # ------------------------------------------------------------
    # Environment after setup
    # ------------------------------------------------------------
    - name: Environment after setup
      run: |
        set -eux
        echo "pythonLocation=$pythonLocation"
        echo "RUNNER_TOOL_CACHE=$RUNNER_TOOL_CACHE"

        echo "PATH entries:"
        echo "$PATH" | tr ':' '\n'

    # ------------------------------------------------------------
    # Resolve python binary
    # ------------------------------------------------------------
    - name: Resolve python binary
      run: |
        set -eux
        which python
        readlink -f "$(which python)"

        echo "Output python-path:"
        echo "${{ steps.setup.outputs.python-path }}"

    # ------------------------------------------------------------
    # Toolcache provenance
    # ------------------------------------------------------------
    - name: Toolcache check
      run: |
        set -eux
        PY=$(readlink -f "$(which python)")
        echo "Python binary: $PY"

        if [[ "$PY" == $RUNNER_TOOL_CACHE/* ]]; then
          echo "Using toolcache"
        else
          echo "Downloaded outside toolcache"
        fi

    # ------------------------------------------------------------
    # ELF inspection
    # ------------------------------------------------------------
    - name: ELF inspection
      run: |
        set -eux
        PY=$(readlink -f "$(which python)")
        file "$PY"
        readelf -d "$PY" | grep -E 'RPATH|RUNPATH' || echo "None"
        ldd "$PY" || true

    # ------------------------------------------------------------
    # Python self-report
    # ------------------------------------------------------------
    - name: Python self-report
      run: |
        python - <<'PY'
import sys, sysconfig, platform
print("Executable:", sys.executable)
print("Prefix:", sys.prefix)
print("Exec Prefix:", sys.exec_prefix)
print("Machine:", platform.machine())
print("LIBDIR:", sysconfig.get_config_var("LIBDIR"))
print("LDLIBRARY:", sysconfig.get_config_var("LDLIBRARY"))
PY
