name: Python Runtime Diagnostics

on:
  workflow_dispatch:
  push:
    branches: [ "debug-python-env" ]

permissions:
  contents: read

jobs:
  proof:
    name: "Python ${{ matrix.python-version }} on ${{ matrix.arch }}"
    runs-on: ${{ matrix.runner }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # x64 baseline (known-good)
          - arch: x64
            runner: ubuntu-latest
            python-setup: actions
            python-version: "3.10"

          # ppc64le under investigation
          - arch: ppc64le
            runner: ubuntu-24.04-ppc64le
            python-setup: ibm
            python-version: "3.10"

    steps:
      # ------------------------------------------------------------
      # Checkout
      # ------------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Python installation
      # ------------------------------------------------------------
      - name: Setup Python (x64)
        if: matrix.python-setup == 'actions'
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Setup Python (ppc64le)
        if: matrix.python-setup == 'ibm'
        uses: IBM/setup-python-pz@v6
        with:
          python-version: ${{ matrix.python-version }}
          architecture: ppc64le

      # ------------------------------------------------------------
      # Environment proof
      # ------------------------------------------------------------
      - name: Dump environment (proof)
        shell: bash
        run: |
          set -eux
          echo "===== UNAME ====="
          uname -a

          echo "===== USER ====="
          id

          echo "===== ENV ====="
          env | sort

          echo "===== PATH ====="
          echo "$PATH" | tr ':' '\n'

          echo "===== LD_LIBRARY_PATH ====="
          echo "${LD_LIBRARY_PATH:-<unset>}"

      # ------------------------------------------------------------
      # Python resolution proof
      # ------------------------------------------------------------
      - name: Resolve python binary
        shell: bash
        run: |
          set -eux
          which python
          readlink -f "$(which python)"
          ls -l "$(dirname "$(which python)")"

      # ------------------------------------------------------------
      # ELF + loader proof
      # ------------------------------------------------------------
      - name: ELF inspection (python)
        shell: bash
        run: |
          set -eux
          PY="$(readlink -f "$(which python)")"

          echo "===== file ====="
          file "$PY"

          echo "===== readelf (RPATH / RUNPATH) ====="
          readelf -d "$PY" | grep -E 'RPATH|RUNPATH' || echo "NO RPATH/RUNPATH"

          echo "===== ldd (dependency resolution) ====="
          ldd "$PY" || true

      # ------------------------------------------------------------
      # libpython location proof
      # ------------------------------------------------------------
      - name: Locate libpython
        shell: bash
        run: |
          set -eux
          PYROOT="$(dirname "$(dirname "$(readlink -f "$(which python)")")")"
          echo "Python root: $PYROOT"

          echo "===== lib dir ====="
          ls -l "$PYROOT/lib" || true

          echo "===== libpython ====="
          ls -l "$PYROOT/lib"/libpython* || true

      # ------------------------------------------------------------
      # Loader cache proof
      # ------------------------------------------------------------
      - name: ldconfig cache
        shell: bash
        run: |
          set -eux
          ldconfig -p | grep libpython || echo "libpython not in ld cache"

      # ------------------------------------------------------------
      # Runtime execution proof (PATH vs relative)
      # ------------------------------------------------------------
      - name: Execute python via PATH (absolute)
        shell: bash
        run: |
          set -eux
          python -VV

      - name: Execute python via relative path
        shell: bash
        run: |
          set -eux
          PYDIR="$(dirname "$(readlink -f "$(which python)")")"
          "$PYDIR/python" -VV

      # ------------------------------------------------------------
      # Exec-path proof (coverage-style re-exec)
      # ------------------------------------------------------------
      - name: Execv test (same exec path as coverage.py)
        shell: bash
        run: |
          set -eux

          cat > exec_test.py <<'EOF'
          import os, sys

          print("parent python executable:", sys.executable)
          print("parent argv:", sys.argv)

          # Replace current process with a fresh python exec
          os.execv(sys.executable, [sys.executable, "-VV"])
          EOF

          python exec_test.py

      # ------------------------------------------------------------
      # Controlled experiment: inject LD_LIBRARY_PATH
      # ------------------------------------------------------------
      - name: Execute python with LD_LIBRARY_PATH injected
        shell: bash
        run: |
          set -eux
          PYROOT="$(dirname "$(dirname "$(readlink -f "$(which python)")")")"
          export LD_LIBRARY_PATH="$PYROOT/lib:${LD_LIBRARY_PATH:-}"
          echo "LD_LIBRARY_PATH=$LD_LIBRARY_PATH"
          python -VV

