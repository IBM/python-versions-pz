name: Reusable Release Python Tar

on:
  workflow_call:
    inputs:
      tag:
        description: "Release tag (e.g., 3.13.3)"
        required: true
        type: string
      files:
        description: "Glob pattern(s) for release files"
        required: false
        type: string
        default: |
          ./artifact/**/*.tar.gz
          ./artifact/**/*.json
          ./artifact/**/*.log
    secrets:
      GH_TOKEN:
        required: true

permissions:
  contents: write # Required for creating releases
  actions: read   # Required for downloading artifacts

jobs:
  release-assets-and-generate-json:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifact
          pattern: python-tar-${{ inputs.tag }}-*
          merge-multiple: true

      - name: List downloaded files (debugging step)
        run: ls -R ./artifact

      - name: Release all .tar.gz files
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag }}
          name: Release ${{ inputs.tag }}
          files: ${{ inputs.files }}
          draft: false
          prerelease: false
          token: ${{ secrets.GH_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          poetry install --no-interaction --no-ansi

      - name: Generate partial manifest
        id: generate_manifest
        env:
          ASSETS_JSON: ${{ steps.create_release.outputs.assets }}
        run: |
          REPO_NAME="${{ github.repository }}" && REPO_NAME="${REPO_NAME##*/}"
          poetry run python .github/scripts/generate_partial_manifest.py \
            --tag "${{ inputs.tag }}" \
            --owner "${{ github.repository_owner }}" \
            --repo "${REPO_NAME}" \
            --assets "$ASSETS_JSON" \
            > manifest-part-${{ inputs.tag }}.json

          echo "Generated Manifest Content:"
          cat manifest-part-${{ inputs.tag }}.json

      - name: Upload partial manifest artifact
        uses: actions/upload-artifact@v4
        with:
          name: manifest-part-${{ inputs.tag }}
          path: manifest-part-${{ inputs.tag }}.json
          retention-days: 1
